package org.exploit.jettyx.http3;

import org.eclipse.jetty.http.HttpVersion;
import org.eclipse.jetty.http3.client.HTTP3Client;
import org.eclipse.jetty.http3.client.http.ClientConnectionFactoryOverHTTP3;
import org.eclipse.jetty.io.ClientConnectionFactory;
import org.eclipse.jetty.io.ClientConnector;
import org.exploit.jettyx.core.version.HttpVersionAdapter;

import java.util.function.Consumer;

public class Http3Version implements HttpVersionAdapter {
    public static final int DEFAULT_PRIORITY = 1;

    private final int priority;
    private final Consumer<HTTP3Client> customizer;

    public Http3Version(int priority, Consumer<HTTP3Client> customizer) {
        this.priority = priority;
        this.customizer = customizer;
    }

    public Http3Version(int priority) {
        this(priority, (client) -> {});
    }

    public Http3Version() {
        this(DEFAULT_PRIORITY);
    }

    @Override
    public int priority() {
        return priority;
    }

    @Override
    public HttpVersion version() {
        return HttpVersion.HTTP_2;
    }

    @Override
    public ClientConnectionFactory.Info getInfo(ClientConnector connector) {
        var client = new HTTP3Client();

        if (customizer != null)
            customizer.accept(client);

        return new ClientConnectionFactoryOverHTTP3.HTTP3(client);
    }
}
