package org.exploit.jettyx.http2;

import org.eclipse.jetty.http.HttpVersion;
import org.eclipse.jetty.http2.client.HTTP2Client;
import org.eclipse.jetty.http2.client.http.ClientConnectionFactoryOverHTTP2;
import org.eclipse.jetty.io.ClientConnectionFactory;
import org.eclipse.jetty.io.ClientConnector;
import org.exploit.jettyx.core.version.HttpVersionAdapter;

import java.util.function.Consumer;

public class Http2Version implements HttpVersionAdapter {
    public static final int DEFAULT_PRIORITY = 2;

    private final int priority;
    private final Consumer<HTTP2Client> customizer;

    public Http2Version(int priority, Consumer<HTTP2Client> customizer) {
        this.priority = priority;
        this.customizer = customizer;
    }

    public Http2Version(int priority) {
        this(priority, (client) -> {});
    }

    public Http2Version() {
        this(DEFAULT_PRIORITY);
    }

    @Override
    public int priority() {
        return priority;
    }

    @Override
    public HttpVersion version() {
        return HttpVersion.HTTP_2;
    }

    @Override
    public ClientConnectionFactory.Info getInfo(ClientConnector connector) {
        var client = new HTTP2Client(connector);

        if (customizer != null)
            customizer.accept(client);

        return new ClientConnectionFactoryOverHTTP2.HTTP2(client);
    }
}
