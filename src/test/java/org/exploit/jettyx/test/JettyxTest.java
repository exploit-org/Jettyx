package org.exploit.jettyx.test;

import lombok.SneakyThrows;
import org.eclipse.jetty.http.HttpVersion;
import org.exploit.jettyx.Jettyx;
import org.exploit.jettyx.auth.NoAuth;
import org.exploit.jettyx.http2.Http2Version;
import org.exploit.jettyx.jackson.JacksonHttpMapper;
import org.exploit.jettyx.test.model.Create;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.util.Map;
import java.util.concurrent.ExecutionException;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;

public class JettyxTest {
    private Jettyx jettyx;

    private ReqresApi api;

    @BeforeEach
    public void setUp() {
        this.jettyx = Jettyx.newBuilder()
                .addHttpMapper(JacksonHttpMapper.create())
                .enableVersion(new Http2Version())
                .build();

        this.api = jettyx.newApiClient("https://reqres.in/", new NoAuth())
                .create(ReqresApi.class);
    }

    @AfterEach
    public void tearDown() {
        jettyx.close();
    }

    @Test
    public void testSimpleGet() {
        var result = api.listUsers(2);
        assertFalse(result.getData().isEmpty());
    }

    @Test
    @SneakyThrows
    public void testSimpleFutureAndQueryMap() {
        var result = api.listUsersFuture(Map.of("page", 2))
                .get();

        assertFalse(result.getData().isEmpty());
    }

    @Test
    public void testFullResponseAndHttpVersion() {
        var body = new Create("gooduser", "badjob");
        var response = api.createUser(body);

        assertEquals("badjob", response.body().getJob());
        assertEquals("gooduser", response.body().getName());

        assertEquals(HttpVersion.HTTP_2, response.rawResponse().getVersion());
    }

    @Test
    public void testFullResponseFutureAndPath() throws ExecutionException, InterruptedException {
        var response = api.getUser(2).get();
        assertEquals(response.body().getData().getEmail(), "janet.weaver@reqres.in");
    }
}
